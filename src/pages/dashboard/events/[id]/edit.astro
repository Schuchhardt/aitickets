---
import DashboardLayout from "../../../../layouts/DashboardLayout.astro";
import EditEventForm from "../../../../components/events/EditEventForm.vue";
import { createSupabaseServerClient } from "../../../../lib/supabaseServer";
import { getSupabaseAdmin } from "../../../../lib/auth-helpers";

const { id } = Astro.params;
const supabase = createSupabaseServerClient(Astro);
const supabaseAdmin = getSupabaseAdmin();

const {
    data: { user },
} = await supabase.auth.getUser();

if (!user) {
    return Astro.redirect("/organizadores/login");
}

// Check ownership first
const { data: dbUser } = await supabase
    .from("users")
    .select("id")
    .eq("auth_user_id", user.id)
    .single();

if (!dbUser) return Astro.redirect("/dashboard/events");

// Fetch Full Event Data
const { data: event, error } = await supabaseAdmin
    .from("events")
    .select(
        `
        *,
        event_tickets (
          id,
          ticket_name,
          price,
          total_quantity
        ),
        event_locations (
           id,
           venue_id,
           name,
           dates:event_dates (
             id,
             date,
             start_time,
             end_time
           ),
           venue:venues (
             id,
             name,
             city
           )
        )
    `,
    )
    .eq("id", id)
    .eq("created_by", dbUser.id)
    .single();

if (error || !event) {
    console.error("Edit fetch error", error);
    return Astro.redirect("/dashboard/events");
}

// Transform Data to Form State
const initialFormState = {
    general: {
        name: event.name,
        description: event.description || "",
        imageUrl: event.image_url || "",
        category: "",
    },
    locations:
        event.event_locations?.map((loc) => ({
            id: loc.id,
            venueId: loc.venue_id,
            isNewVenue: false,
            newVenueName: "",
            newVenueAddress: "",
            newVenueCity: "",
            dates:
                loc.dates?.map((d) => ({
                    id: d.id,
                    date: d.date,
                    startTime: d.start_time?.slice(0, 5) || "21:00",
                    endTime: d.end_time?.slice(0, 5) || "04:00",
                })) || [],
        })) || [],
    tickets:
        event.event_tickets?.map((t) => ({
            id: t.id,
            name: t.ticket_name,
            price: Number(t.price),
            quantity: t.total_quantity,
            description: "",
        })) || [],
};

// Fetch venues for the dropdown
const { data: venues } = await supabase.from("venues").select("id, name, city");
---

<DashboardLayout title={`Editar ${event.name}`}>
    <div class="max-w-4xl mx-auto">
        <div class="mb-8">
            <a
                href={`/dashboard/events/${id}`}
                class="text-gray-500 hover:text-black mb-2 inline-block text-sm"
                >&larr; Volver al Dashboard</a
            >
            <h1 class="text-3xl font-bold font-[Unbounded]">Editar Evento</h1>
        </div>

        <EditEventForm
            client:load
            eventId={id}
            initialFormState={initialFormState}
            initialVenues={venues || []}
        />
    </div>
</DashboardLayout>
