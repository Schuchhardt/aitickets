---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import { Plus, Calendar, MapPin, Eye, Edit } from "lucide-vue-next";
import { createSupabaseServerClient } from "../../../lib/supabaseServer";

const supabase = createSupabaseServerClient(Astro);
const {
  data: { user },
} = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect("/organizadores/login");
}

// Get public user info (organization_id)
const { data: dbUser } = await supabase
  .from("users")
  .select("organization_id")
  .eq("auth_user_id", user.id)
  .single();

if (!dbUser || !dbUser.organization_id) {
  // Handle case where user implies no organization (shouldn't happen for producers)
  // For now, return empty or redirect
  console.error("User request without organization_id");
}

// Fetch events
const query = supabase
  .from("events")
  .select("*")
  .order("created_at", { ascending: false });

if (dbUser?.organization_id) {
  query.eq("organization_id", dbUser.organization_id);
}

const { data: events } = await query;
---

<DashboardLayout title="Mis Eventos">
  <div
    class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8"
  >
    <div>
      <h1 class="text-3xl font-bold font-[Unbounded] mb-2">Mis Eventos</h1>
      <p class="text-gray-600">Gestiona y monitorea todos tus eventos.</p>
    </div>

    <a
      href="/dashboard/events/create"
      class="inline-flex items-center gap-2 bg-black text-white px-5 py-2.5 rounded-lg hover:bg-gray-800 transition font-medium"
    >
      <Plus size="20" />
      Crear Evento
    </a>
  </div>

  {
    !events || events.length === 0 ? (
      <div
        id="empty-state"
        class="bg-white rounded-xl shadow-sm border border-gray-100 p-12 text-center"
      >
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
          <Calendar size="32" />
        </div>
        <h3 class="text-xl font-bold mb-2">No tienes eventos activos</h3>
        <p class="text-gray-500 mb-6">
          Crea tu primer evento para comenzar a vender entradas.
        </p>
        <a
          href="/dashboard/events/create"
          class="inline-flex bg-black text-white px-6 py-3 rounded-lg hover:bg-gray-800 transition font-medium"
        >
          Crear Evento
        </a>
      </div>
    ) : (
      <div
        id="events-grid"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        {events.map((event) => (
          <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition group">
            <div class="aspect-video bg-gray-200 relative overflow-hidden">
              {event.image_url ? (
                <img src={event.image_url} class="w-full h-full object-cover" />
              ) : (
                <div class="w-full h-full flex items-center justify-center text-gray-400">
                  <Calendar size="32" />
                </div>
              )}
            </div>

            <div class="p-5">
              <div class="flex justify-between items-start mb-2">
                <span
                  class={`px-2 py-1 text-xs font-medium rounded-full ${event.status === "published" ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-600"}`}
                >
                  {event.status === "published" ? "Publicado" : "Borrador"}
                </span>
                <span class="text-xs text-gray-500">
                  {new Date(event.start_date).toLocaleDateString()}
                </span>
              </div>

              <h3 class="font-bold text-lg mb-2 font-[Unbounded] line-clamp-1">
                {event.title || event.name}
              </h3>

              <div class="flex items-center gap-2 text-sm text-gray-600 mb-4">
                <MapPin size="16" />
                <span class="truncate">
                  {event.address || "Ubicaci√≥n por definir"}
                </span>
              </div>

              <div class="flex gap-2 mt-4 pt-4 border-t border-gray-50">
                <a
                  href={`/dashboard/events/${event.id}`}
                  class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-50 rounded-lg hover:bg-gray-100 transition"
                >
                  <Eye size="16" /> Gestionar
                </a>
                <a
                  href={`/dashboard/events/${event.id}/edit`}
                  class="flex-1 flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium text-white bg-black rounded-lg hover:bg-gray-800 transition"
                >
                  <Edit size="16" /> Editar
                </a>
              </div>
            </div>
          </div>
        ))}
      </div>
    )
  }
</DashboardLayout>
