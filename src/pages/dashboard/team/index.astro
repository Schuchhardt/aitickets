---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import {
    getSessionUser,
    createSupabaseServerClient,
} from "../../../lib/supabaseServer";
import { Users, UserPlus, Shield, Edit3, Ticket, Crown, X, Pencil, UserX, UserCheck, AlertTriangle } from "lucide-vue-next";

const user = await getSessionUser(Astro);

if (!user) {
    return Astro.redirect("/organizadores/login");
}

// Fetch user data including organization info
const supabase = createSupabaseServerClient(Astro);
const { data: dbUser } = await supabase
    .from("users")
    .select("organization_id, role")
    .eq("auth_user_id", user.id)
    .single();

if (!dbUser || !dbUser.organization_id) {
    return Astro.redirect("/organizadores/login");
}

// Fetch team members
const { data: teamMembers } = await supabase
    .from("users")
    .select("id, name, email, role, created_at, last_access_at, active")
    .eq("organization_id", dbUser.organization_id)
    .order("created_at", { ascending: true });

// Fetch organization name
const { data: organization } = await supabase
    .from("organizations")
    .select("public_name")
    .eq("id", dbUser.organization_id)
    .single();

const isAdmin = dbUser.role === "admin";
const members = teamMembers || [];

// Role display config
const roleConfig: Record<string, { label: string; color: string; icon: string }> = {
    admin: { label: "Administrador", color: "bg-purple-100 text-purple-700", icon: "crown" },
    editor: { label: "Editor", color: "bg-blue-100 text-blue-700", icon: "edit" },
    validator: { label: "Validador", color: "bg-green-100 text-green-700", icon: "ticket" },
};
---

<DashboardLayout title="Mi Equipo">
    <div class="space-y-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold font-[Unbounded] text-gray-900">Mi Equipo</h1>
                <p class="text-gray-600 mt-1">
                    {organization?.public_name || "Tu organización"} · {members.length} miembro{members.length !== 1 ? "s" : ""}
                </p>
            </div>
            {isAdmin && (
                <button
                    id="openModalBtn"
                    class="inline-flex items-center gap-2 px-5 py-2.5 bg-black text-white rounded-lg hover:bg-gray-800 transition-all font-medium shadow-sm hover:shadow-md transform active:scale-95"
                >
                    <UserPlus size="20" />
                    Invitar Miembro
                </button>
            )}
        </div>

        <!-- Roles Filter -->
        <div class="flex flex-wrap gap-3">
            <button 
                type="button"
                data-role-filter="all"
                class="role-filter-btn flex items-center gap-2 px-3 py-1.5 bg-gray-900 text-white rounded-full border border-gray-900 cursor-pointer transition-all hover:opacity-90"
            >
                <Users size="14" />
                <span class="text-xs font-medium">Todos</span>
            </button>
            <button 
                type="button"
                data-role-filter="admin"
                class="role-filter-btn flex items-center gap-2 px-3 py-1.5 bg-purple-50 rounded-full border border-purple-100 cursor-pointer transition-all hover:bg-purple-100"
            >
                <Crown size="14" class="text-purple-600" />
                <span class="text-xs font-medium text-purple-700">Administradores</span>
            </button>
            <button 
                type="button"
                data-role-filter="editor"
                class="role-filter-btn flex items-center gap-2 px-3 py-1.5 bg-blue-50 rounded-full border border-blue-100 cursor-pointer transition-all hover:bg-blue-100"
            >
                <Edit3 size="14" class="text-blue-600" />
                <span class="text-xs font-medium text-blue-700">Editores</span>
            </button>
            <button 
                type="button"
                data-role-filter="validator"
                class="role-filter-btn flex items-center gap-2 px-3 py-1.5 bg-green-50 rounded-full border border-green-100 cursor-pointer transition-all hover:bg-green-100"
            >
                <Ticket size="14" class="text-green-600" />
                <span class="text-xs font-medium text-green-700">Validadores</span>
            </button>
        </div>

        <!-- Team Members List -->
        {members.length === 0 ? (
            <div class="bg-white rounded-xl border border-gray-100 p-12 text-center shadow-sm">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                    <Users size="32" />
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">
                    No hay miembros en tu equipo
                </h3>
                <p class="text-gray-500 mb-6 max-w-md mx-auto">
                    Invita a otros miembros de tu equipo para que te ayuden a gestionar eventos y validar entradas.
                </p>
                {isAdmin && (
                    <button
                        id="openModalBtnEmpty"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition font-medium"
                    >
                        <UserPlus size="20" />
                        Invitar Primer Miembro
                    </button>
                )}
            </div>
        ) : (
            <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Miembro
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Rol
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden md:table-cell">
                                    Último acceso
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider hidden md:table-cell">
                                    Estado
                                </th>
                                {isAdmin && (
                                    <th class="px-6 py-4 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Acciones
                                    </th>
                                )}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {members.map((member, index) => {
                                const config = roleConfig[member.role] || roleConfig.editor;
                                const initials = member.name 
                                    ? member.name.split(" ").map((n: string) => n[0]).join("").toUpperCase().slice(0, 2)
                                    : member.email?.[0]?.toUpperCase() || "?";
                                const isCurrentUser = member.email === user.email;
                                
                                return (
                                    <tr class="member-row hover:bg-gray-50 transition-colors" data-role={member.role}>
                                        <td class="px-6 py-4">
                                            <div class="flex items-center gap-3">
                                                <div 
                                                    class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-800 to-gray-600 text-white flex items-center justify-center font-semibold text-sm flex-shrink-0"
                                                    style={`background: linear-gradient(135deg, hsl(${(index * 47) % 360}, 60%, 45%), hsl(${(index * 47 + 30) % 360}, 60%, 35%))`}
                                                >
                                                    {initials}
                                                </div>
                                                <div class="min-w-0">
                                                    <div class="flex items-center gap-2">
                                                        <span class="font-medium text-gray-900 truncate">
                                                            {member.name || "Sin nombre"}
                                                        </span>
                                                        {isCurrentUser && (
                                                            <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded-full">
                                                                Tú
                                                            </span>
                                                        )}
                                                    </div>
                                                    <span class="text-sm text-gray-500 truncate block">
                                                        {member.email}
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <span class={`inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full ${config.color}`}>
                                                {member.role === "admin" && <Crown size="12" />}
                                                {member.role === "editor" && <Edit3 size="12" />}
                                                {member.role === "validator" && <Ticket size="12" />}
                                                {config.label}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 hidden md:table-cell">
                                            <span class="text-sm text-gray-600">
                                                {member.last_access_at 
                                                    ? new Date(member.last_access_at).toLocaleDateString("es-CL", { day: "numeric", month: "short", year: "numeric" })
                                                    : "Nunca"
                                                }
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 hidden md:table-cell">
                                            {member.active !== false ? (
                                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-green-50 text-green-700">
                                                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                                                    Activo
                                                </span>
                                            ) : (
                                                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-600">
                                                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full"></span>
                                                    Inactivo
                                                </span>
                                            )}
                                        </td>
                                        {isAdmin && (
                                            <td class="px-6 py-4 text-right">
                                                <div class="flex items-center justify-end gap-1">
                                                    <button
                                                        class="edit-member-btn p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition-colors"
                                                        data-member-id={member.id}
                                                        data-member-name={member.name || ""}
                                                        data-member-email={member.email}
                                                        data-member-role={member.role}
                                                        data-is-current={isCurrentUser ? "true" : "false"}
                                                        title="Editar miembro"
                                                    >
                                                        <Pencil size="18" />
                                                    </button>
                                                    {!isCurrentUser && (
                                                        <button
                                                            class={`toggle-status-btn p-2 rounded-lg transition-colors ${member.active !== false ? 'text-amber-500 hover:text-amber-700 hover:bg-amber-50' : 'text-green-500 hover:text-green-700 hover:bg-green-50'}`}
                                                            data-member-id={member.id}
                                                            data-member-name={member.name || member.email}
                                                            data-member-active={member.active !== false ? "true" : "false"}
                                                            title={member.active !== false ? "Desactivar usuario" : "Reactivar usuario"}
                                                        >
                                                            {member.active !== false ? <UserX size="18" /> : <UserCheck size="18" />}
                                                        </button>
                                                    )}
                                                </div>
                                            </td>
                                        )}
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                </div>
            </div>
        )}
    </div>

    <!-- Modal for adding new member -->
    {isAdmin && (
        <div id="addMemberModal" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div id="modalBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
            
            <!-- Modal Content -->
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative animate-in fade-in zoom-in duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-100">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900 font-[Unbounded]">Invitar Miembro</h2>
                            <p class="text-sm text-gray-500 mt-1">Agrega un nuevo miembro a tu equipo</p>
                        </div>
                        <button id="closeModalBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <X size="20" class="text-gray-500" />
                        </button>
                    </div>

                    <!-- Form -->
                    <form id="addMemberForm" class="p-6 space-y-5">
                        <div id="formMessage" class="hidden p-4 rounded-lg text-sm"></div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nombre completo
                            </label>
                            <input
                                type="text"
                                name="name"
                                required
                                placeholder="Ej: Juan Pérez"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black focus:border-black outline-none transition-all"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Correo electrónico
                            </label>
                            <input
                                type="email"
                                name="email"
                                required
                                placeholder="juan@ejemplo.com"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black focus:border-black outline-none transition-all"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Rol
                            </label>
                            <select
                                name="role"
                                required
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black focus:border-black outline-none transition-all bg-white"
                            >
                                <option value="">Selecciona un rol</option>
                                <option value="admin">Administrador - Acceso total</option>
                                <option value="editor">Editor - Gestionar eventos</option>
                                <option value="validator">Validador - Solo validar entradas</option>
                            </select>
                            <p class="mt-2 text-xs text-gray-500">
                                Los administradores pueden gestionar el equipo, los editores pueden crear y editar eventos, y los validadores solo pueden escanear entradas.
                            </p>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button
                                type="button"
                                id="cancelBtn"
                                class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
                            >
                                Cancelar
                            </button>
                            <button
                                type="submit"
                                id="submitBtn"
                                class="flex-1 px-4 py-2.5 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <span id="submitText">Invitar</span>
                                <div id="spinner" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    )}

    <!-- Modal for editing member -->
    {isAdmin && (
        <div id="editMemberModal" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div id="editModalBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
            
            <!-- Modal Content -->
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative animate-in fade-in zoom-in duration-200">
                    <!-- Header -->
                    <div class="flex items-center justify-between p-6 border-b border-gray-100">
                        <div>
                            <h2 class="text-xl font-bold text-gray-900 font-[Unbounded]">Editar Miembro</h2>
                            <p class="text-sm text-gray-500 mt-1">Modifica los datos del miembro</p>
                        </div>
                        <button id="closeEditModalBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                            <X size="20" class="text-gray-500" />
                        </button>
                    </div>

                    <!-- Form -->
                    <form id="editMemberForm" class="p-6 space-y-5">
                        <input type="hidden" name="userId" id="editUserId" />
                        <div id="editFormMessage" class="hidden p-4 rounded-lg text-sm"></div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nombre completo
                            </label>
                            <input
                                type="text"
                                name="name"
                                id="editName"
                                required
                                placeholder="Ej: Juan Pérez"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black focus:border-black outline-none transition-all"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Correo electrónico
                            </label>
                            <input
                                type="email"
                                name="email"
                                id="editEmail"
                                required
                                placeholder="juan@ejemplo.com"
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black focus:border-black outline-none transition-all"
                            />
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Rol
                            </label>
                            <select
                                name="role"
                                id="editRole"
                                required
                                class="w-full px-4 py-2.5 rounded-lg border border-gray-300 focus:ring-2 focus:ring-black focus:border-black outline-none transition-all bg-white"
                            >
                                <option value="admin">Administrador - Acceso total</option>
                                <option value="editor">Editor - Gestionar eventos</option>
                                <option value="validator">Validador - Solo validar entradas</option>
                            </select>
                            <p id="editRoleWarning" class="mt-2 text-xs text-amber-600 hidden">
                                ⚠️ No puedes remover tu propio rol de administrador.
                            </p>
                            <p class="mt-2 text-xs text-gray-500">
                                Los administradores pueden gestionar el equipo, los editores pueden crear y editar eventos, y los validadores solo pueden escanear entradas.
                            </p>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button
                                type="button"
                                id="cancelEditBtn"
                                class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
                            >
                                Cancelar
                            </button>
                            <button
                                type="submit"
                                id="submitEditBtn"
                                class="flex-1 px-4 py-2.5 bg-black text-white rounded-lg hover:bg-gray-800 transition-colors font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <span id="submitEditText">Guardar Cambios</span>
                                <div id="editSpinner" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    )}

    <!-- Modal for confirming status toggle -->
    {isAdmin && (
        <div id="toggleStatusModal" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div id="toggleModalBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
            
            <!-- Modal Content -->
            <div class="absolute inset-0 flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative animate-in fade-in zoom-in duration-200">
                    <!-- Header -->
                    <div class="p-6 text-center">
                        <div id="toggleIconContainer" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                            <!-- Icon will be set dynamically -->
                        </div>
                        <h2 id="toggleModalTitle" class="text-xl font-bold text-gray-900 font-[Unbounded]"></h2>
                        <p id="toggleModalMessage" class="text-sm text-gray-500 mt-2"></p>
                    </div>

                    <!-- Actions -->
                    <div class="p-6 pt-0 flex gap-3">
                        <button
                            type="button"
                            id="cancelToggleBtn"
                            class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium"
                        >
                            Cancelar
                        </button>
                        <button
                            type="button"
                            id="confirmToggleBtn"
                            class="flex-1 px-4 py-2.5 rounded-lg transition-colors font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span id="toggleBtnText">Confirmar</span>
                            <div id="toggleSpinner" class="hidden animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    )}
</DashboardLayout>

<style>
    @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes zoom-in {
        from { transform: scale(0.95); }
        to { transform: scale(1); }
    }
    
    .animate-in {
        animation: fade-in 0.2s ease-out, zoom-in 0.2s ease-out;
    }
</style>

<script>
    // ============================================
    // ROLE FILTER FUNCTIONALITY
    // ============================================
    const roleFilterBtns = document.querySelectorAll('.role-filter-btn');
    const memberRows = document.querySelectorAll('.member-row');

    function setActiveFilter(activeBtn: HTMLElement) {
        // Reset all buttons to default style
        roleFilterBtns.forEach(btn => {
            const role = (btn as HTMLElement).dataset.roleFilter;
            btn.classList.remove('bg-gray-900', 'text-white', 'border-gray-900');
            
            if (role === 'all') {
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-200');
            } else if (role === 'admin') {
                btn.classList.add('bg-purple-50', 'text-purple-700', 'border-purple-100');
            } else if (role === 'editor') {
                btn.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-100');
            } else if (role === 'validator') {
                btn.classList.add('bg-green-50', 'text-green-700', 'border-green-100');
            }
        });

        // Style the active button
        activeBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-200',
            'bg-purple-50', 'text-purple-700', 'border-purple-100',
            'bg-blue-50', 'text-blue-700', 'border-blue-100',
            'bg-green-50', 'text-green-700', 'border-green-100');
        activeBtn.classList.add('bg-gray-900', 'text-white', 'border-gray-900');
    }

    function filterByRole(role: string) {
        memberRows.forEach(row => {
            const rowRole = (row as HTMLElement).dataset.role;
            if (role === 'all' || rowRole === role) {
                (row as HTMLElement).style.display = '';
            } else {
                (row as HTMLElement).style.display = 'none';
            }
        });
    }

    roleFilterBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget as HTMLElement;
            const role = target.dataset.roleFilter || 'all';
            
            setActiveFilter(target);
            filterByRole(role);
        });
    });

    // ============================================
    // ADD MEMBER MODAL
    // ============================================
    const modal = document.getElementById('addMemberModal');
    const openBtns = [document.getElementById('openModalBtn'), document.getElementById('openModalBtnEmpty')];
    const closeBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const backdrop = document.getElementById('modalBackdrop');
    const form = document.getElementById('addMemberForm') as HTMLFormElement;
    const formMessage = document.getElementById('formMessage');
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const submitText = document.getElementById('submitText');
    const spinner = document.getElementById('spinner');

    function openModal() {
        if (modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal() {
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            if (form) form.reset();
            if (formMessage) {
                formMessage.classList.add('hidden');
                formMessage.className = 'hidden p-4 rounded-lg text-sm';
            }
        }
    }

    openBtns.forEach(btn => {
        if (btn) btn.addEventListener('click', openModal);
    });

    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
    if (backdrop) backdrop.addEventListener('click', closeModal);

    // Form submission for adding member
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Reset state
            if (formMessage) {
                formMessage.classList.add('hidden');
                formMessage.className = 'hidden p-4 rounded-lg text-sm';
            }
            if (submitBtn) submitBtn.disabled = true;
            if (spinner) spinner.classList.remove('hidden');
            if (submitText) submitText.textContent = 'Invitando...';

            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                email: formData.get('email'),
                role: formData.get('role'),
            };

            try {
                const response = await fetch('/api/team/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (formMessage) {
                    formMessage.classList.remove('hidden');
                }

                if (response.ok) {
                    if (formMessage) {
                        formMessage.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
                        formMessage.innerHTML = `
                            <strong>¡Miembro agregado exitosamente!</strong><br>
                            <span class="text-xs">Contraseña temporal: <code class="bg-green-100 px-1 rounded">${result.tempPassword}</code></span><br>
                            <span class="text-xs text-green-600">Comparte esta contraseña con el nuevo miembro.</span>
                        `;
                    }
                    // Reload page after 3 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Error al agregar miembro');
                }
            } catch (error: any) {
                if (formMessage) {
                    formMessage.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
                    formMessage.textContent = error.message;
                }
            } finally {
                if (submitBtn) submitBtn.disabled = false;
                if (spinner) spinner.classList.add('hidden');
                if (submitText) submitText.textContent = 'Invitar';
            }
        });
    }

    // ============================================
    // EDIT MEMBER MODAL
    // ============================================
    const editModal = document.getElementById('editMemberModal');
    const closeEditBtn = document.getElementById('closeEditModalBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const editBackdrop = document.getElementById('editModalBackdrop');
    const editForm = document.getElementById('editMemberForm') as HTMLFormElement;
    const editFormMessage = document.getElementById('editFormMessage');
    const submitEditBtn = document.getElementById('submitEditBtn') as HTMLButtonElement;
    const submitEditText = document.getElementById('submitEditText');
    const editSpinner = document.getElementById('editSpinner');
    const editUserId = document.getElementById('editUserId') as HTMLInputElement;
    const editName = document.getElementById('editName') as HTMLInputElement;
    const editEmail = document.getElementById('editEmail') as HTMLInputElement;
    const editRole = document.getElementById('editRole') as HTMLSelectElement;
    const editRoleWarning = document.getElementById('editRoleWarning');

    let isEditingCurrentUser = false;

    function openEditModal(memberId: string, name: string, email: string, role: string, isCurrent: boolean) {
        if (editModal) {
            isEditingCurrentUser = isCurrent;
            editUserId.value = memberId;
            editName.value = name;
            editEmail.value = email;
            editRole.value = role;
            
            // Show warning and disable role change if editing self
            if (isCurrent && editRoleWarning) {
                editRoleWarning.classList.remove('hidden');
                // Optionally disable role change for self
                // editRole.disabled = true;
            } else if (editRoleWarning) {
                editRoleWarning.classList.add('hidden');
                // editRole.disabled = false;
            }
            
            editModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeEditModal() {
        if (editModal) {
            editModal.classList.add('hidden');
            document.body.style.overflow = '';
            if (editForm) editForm.reset();
            if (editFormMessage) {
                editFormMessage.classList.add('hidden');
                editFormMessage.className = 'hidden p-4 rounded-lg text-sm';
            }
            isEditingCurrentUser = false;
        }
    }

    // Attach click handlers to all edit buttons
    document.querySelectorAll('.edit-member-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget as HTMLElement;
            const memberId = target.dataset.memberId || '';
            const name = target.dataset.memberName || '';
            const email = target.dataset.memberEmail || '';
            const role = target.dataset.memberRole || '';
            const isCurrent = target.dataset.isCurrent === 'true';
            openEditModal(memberId, name, email, role, isCurrent);
        });
    });

    if (closeEditBtn) closeEditBtn.addEventListener('click', closeEditModal);
    if (cancelEditBtn) cancelEditBtn.addEventListener('click', closeEditModal);
    if (editBackdrop) editBackdrop.addEventListener('click', closeEditModal);

    // Form submission for editing member
    if (editForm) {
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Reset state
            if (editFormMessage) {
                editFormMessage.classList.add('hidden');
                editFormMessage.className = 'hidden p-4 rounded-lg text-sm';
            }
            if (submitEditBtn) submitEditBtn.disabled = true;
            if (editSpinner) editSpinner.classList.remove('hidden');
            if (submitEditText) submitEditText.textContent = 'Guardando...';

            const formData = new FormData(editForm);
            const data = {
                userId: formData.get('userId'),
                name: formData.get('name'),
                email: formData.get('email'),
                role: formData.get('role'),
            };

            try {
                const response = await fetch('/api/team/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (editFormMessage) {
                    editFormMessage.classList.remove('hidden');
                }

                if (response.ok) {
                    if (editFormMessage) {
                        editFormMessage.classList.add('bg-green-50', 'text-green-800', 'border', 'border-green-200');
                        editFormMessage.textContent = '¡Usuario actualizado exitosamente!';
                    }
                    // Reload page after 1.5 seconds
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Error al actualizar miembro');
                }
            } catch (error: any) {
                if (editFormMessage) {
                    editFormMessage.classList.add('bg-red-50', 'text-red-800', 'border', 'border-red-200');
                    editFormMessage.textContent = error.message;
                }
            } finally {
                if (submitEditBtn) submitEditBtn.disabled = false;
                if (editSpinner) editSpinner.classList.add('hidden');
                if (submitEditText) submitEditText.textContent = 'Guardar Cambios';
            }
        });
    }

    // ============================================
    // TOGGLE STATUS MODAL
    // ============================================
    const toggleModal = document.getElementById('toggleStatusModal');
    const toggleModalBackdrop = document.getElementById('toggleModalBackdrop');
    const cancelToggleBtn = document.getElementById('cancelToggleBtn');
    const confirmToggleBtn = document.getElementById('confirmToggleBtn') as HTMLButtonElement;
    const toggleBtnText = document.getElementById('toggleBtnText');
    const toggleSpinner = document.getElementById('toggleSpinner');
    const toggleIconContainer = document.getElementById('toggleIconContainer');
    const toggleModalTitle = document.getElementById('toggleModalTitle');
    const toggleModalMessage = document.getElementById('toggleModalMessage');

    let currentToggleUserId: string | null = null;
    let currentToggleAction: 'deactivate' | 'activate' = 'deactivate';

    function openToggleModal(userId: string, memberName: string, isActive: boolean) {
        if (!toggleModal) return;
        
        currentToggleUserId = userId;
        currentToggleAction = isActive ? 'deactivate' : 'activate';

        if (isActive) {
            // Deactivating
            if (toggleIconContainer) {
                toggleIconContainer.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-amber-100';
                toggleIconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-600"><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"/><line x1="23" x2="1" y1="1" y2="23"/></svg>`;
            }
            if (toggleModalTitle) toggleModalTitle.textContent = '¿Desactivar usuario?';
            if (toggleModalMessage) toggleModalMessage.innerHTML = `<strong>${memberName}</strong> no podrá iniciar sesión hasta que lo reactives.`;
            if (confirmToggleBtn) {
                confirmToggleBtn.className = 'flex-1 px-4 py-2.5 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed';
            }
            if (toggleBtnText) toggleBtnText.textContent = 'Desactivar';
        } else {
            // Reactivating
            if (toggleIconContainer) {
                toggleIconContainer.className = 'w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 bg-green-100';
                toggleIconContainer.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>`;
            }
            if (toggleModalTitle) toggleModalTitle.textContent = '¿Reactivar usuario?';
            if (toggleModalMessage) toggleModalMessage.innerHTML = `<strong>${memberName}</strong> podrá volver a iniciar sesión normalmente.`;
            if (confirmToggleBtn) {
                confirmToggleBtn.className = 'flex-1 px-4 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed';
            }
            if (toggleBtnText) toggleBtnText.textContent = 'Reactivar';
        }

        toggleModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeToggleModal() {
        if (toggleModal) {
            toggleModal.classList.add('hidden');
            document.body.style.overflow = '';
            currentToggleUserId = null;
        }
    }

    // Attach click handlers to all toggle buttons
    document.querySelectorAll('.toggle-status-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const target = e.currentTarget as HTMLElement;
            const memberId = target.dataset.memberId || '';
            const memberName = target.dataset.memberName || '';
            const isActive = target.dataset.memberActive === 'true';
            openToggleModal(memberId, memberName, isActive);
        });
    });

    if (cancelToggleBtn) cancelToggleBtn.addEventListener('click', closeToggleModal);
    if (toggleModalBackdrop) toggleModalBackdrop.addEventListener('click', closeToggleModal);

    // Confirm toggle
    if (confirmToggleBtn) {
        confirmToggleBtn.addEventListener('click', async () => {
            if (!currentToggleUserId) return;

            confirmToggleBtn.disabled = true;
            if (toggleSpinner) toggleSpinner.classList.remove('hidden');
            if (toggleBtnText) toggleBtnText.textContent = currentToggleAction === 'deactivate' ? 'Desactivando...' : 'Reactivando...';

            try {
                const response = await fetch('/api/team/toggle-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentToggleUserId,
                        active: currentToggleAction === 'activate'
                    }),
                });

                const result = await response.json();

                if (response.ok) {
                    // Reload page to reflect changes
                    window.location.reload();
                } else {
                    alert(result.error || 'Error al cambiar el estado');
                    closeToggleModal();
                }
            } catch (error: any) {
                alert('Error de conexión');
                closeToggleModal();
            } finally {
                confirmToggleBtn.disabled = false;
                if (toggleSpinner) toggleSpinner.classList.add('hidden');
                if (toggleBtnText) toggleBtnText.textContent = 'Confirmar';
            }
        });
    }

    // ============================================
    // GLOBAL: Close modals on Escape key
    // ============================================
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            if (modal && !modal.classList.contains('hidden')) {
                closeModal();
            }
            if (editModal && !editModal.classList.contains('hidden')) {
                closeEditModal();
            }
            if (toggleModal && !toggleModal.classList.contains('hidden')) {
                closeToggleModal();
            }
        }
    });
</script>
