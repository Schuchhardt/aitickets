---
import _ from "lodash";
import { supabase } from "../../lib/supabaseClient";
import AppFooter from "../../components/AppFooter.vue";
import EventDetail from "../../components/EventDetail.vue";
import EventAssistant from "../../components/EventAssistant.vue";
import EventMetaTags from "../../components/EventMetaTags.astro";

import Layout from '../../layouts/Layout.astro';
import "../../styles/global.css";

export const prerender = false;

const { slug } = Astro.params;

// Obtener el evento
const { data: event, error } = await supabase
  .from("events")
  .select("*")
  .eq("slug", slug)
  .single();

if (!error || event) {
  // Obtener las categorías del evento
  const { data: categories, error: errorCategories } = await supabase
    .from("event_tags")
    .select("category_tags(name)") 
    .eq("event_id", event.id);

  //load categories
  if (errorCategories) {
    console.error("Error al obtener las categorías:", errorCategories);
  } else {
    // @ts-ignore
    event.tags = categories.map(c => c.category_tags).map(ct => ct.name);
  }

  //load tickets // TODO VALIDAR STOCK DE VENDIDAS QUE SEA MENOR A MAX_QTY
  const { data: event_tickets, error: errorTickets } = await supabase
  .from("event_tickets")
  .select("*")
  .eq("event_id", event.id) 
  .eq("is_gift", false) 
  .eq("status", "available")
  .lte("init_date", new Date().toISOString())
  .gte("end_date", new Date().toISOString())
  .gte("max_quantity", 1)
  .order("price", { ascending: true }); // Ordenar por precio

  console.log("event_tickets", event_tickets);

  if (errorTickets){
    console.error("Error al obtener las entradas:", errorTickets);
    event.tickets = []
  } else {
    event.tickets = event_tickets
  }

  // load event faqs
  const { data: event_faqs, error: errorFaqs } = await supabase
  .from("event_faqs")
  .select("*")
  .eq("event_id", event.id)
  if (errorFaqs){
    console.error("Error al obtener las faqs:", errorTickets);
    event.faqs = []
  } else {
    event.faqs = event_faqs;
  }

  // load event dates
  const getTimeFromTimestamp = (timestamp) => {
    // IMPORTANTE: Extraer la hora usando la zona horaria del usuario
    // para que sea consistente con el resto de la aplicación
    const date = new Date(timestamp);
    return date.toLocaleTimeString("es-CL", {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false,
      timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone // Zona horaria del usuario
    });
  };
  const defaultDate = {date: event.start_date, start_time: getTimeFromTimestamp(event.start_date), end_time: getTimeFromTimestamp(event.end_date)};
  const { data: event_dates, error: errorDates } = await supabase
  .from("event_dates")
  .select("*")
  .eq("event_id", event.id)
  if (errorDates){
    console.error("Error al obtener las fechas:", errorDates);
    event.dates = [defaultDate]
  } else {
    event.dates = event_dates.length > 0 ? event_dates : [defaultDate];
  }
  
  
} else {
  console.error("Error al obtener el evento:", error);
  // redirect to 404
  Astro.redirect('/404');
}


---
<Layout>
  <EventMetaTags event={event} />
    <EventDetail event={event} v-if={event} client:idle/>
    <EventAssistant event={event} v-if={event} client:idle/>
    <AppFooter client:idle/>
</Layout>
